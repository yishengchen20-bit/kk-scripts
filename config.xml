#!/bin/bash

# ç†è´¢åŠ©æ‰‹APKæ„å»ºè„šæœ¬
# ä½¿ç”¨æ–¹æ³•ï¼š./build-apk.sh

set -e

echo "ğŸš€ ç†è´¢åŠ©æ‰‹APKæ„å»ºè„šæœ¬"
echo "======================="

# æ£€æŸ¥Node.jsç¯å¢ƒ
if ! command -v node &> /dev/null; then
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°Node.jsã€‚è¯·å…ˆå®‰è£…Node.js 16.xæˆ–æ›´é«˜ç‰ˆæœ¬ã€‚"
    exit 1
fi

if ! command -v npm &> /dev/null; then
    echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°npmã€‚è¯·å…ˆå®‰è£…Node.jsã€‚"
    exit 1
fi

NODE_VERSION=$(node -v | cut -d'v' -f2)
echo "âœ… Node.jsç‰ˆæœ¬: $NODE_VERSION"

# æ£€æŸ¥Cordovaæ˜¯å¦å®‰è£…
if ! command -v cordova &> /dev/null; then
    echo "ğŸ“¦ æ­£åœ¨å®‰è£…Cordova..."
    npm install -g cordova
fi

CORDOVA_VERSION=$(cordova -v)
echo "âœ… Cordovaç‰ˆæœ¬: $CORDOVA_VERSION"

# åˆ›å»ºèµ„æºç›®å½•
echo "ğŸ“ åˆ›å»ºèµ„æºç›®å½•..."
mkdir -p res/icon/android
mkdir -p res/screen/android

# ä¸‹è½½é»˜è®¤å›¾æ ‡ï¼ˆä½¿ç”¨å ä½å›¾æ ‡ï¼‰
echo "ğŸ–¼ï¸ ä¸‹è½½åº”ç”¨å›¾æ ‡..."
curl -s -o res/icon/android/icon-192-xxxhdpi.png "https://img.icons8.com/color/192/000000/trophy.png"
curl -s -o res/icon/android/icon-144-xxhdpi.png "https://img.icons8.com/color/144/000000/trophy.png"
curl -s -o res/icon/android/icon-96-xhdpi.png "https://img.icons8.com/color/96/000000/trophy.png"
curl -s -o res/icon/android/icon-72-hdpi.png "https://img.icons8.com/color/72/000000/trophy.png"
curl -s -o res/icon/android/icon-48-mdpi.png "https://img.icons8.com/color/48/000000/trophy.png"
curl -s -o res/icon/android/icon-36-ldpi.png "https://img.icons8.com/color/36/000000/trophy.png"

# åˆ›å»ºç®€å•çš„å¯åŠ¨å›¾
echo "ğŸ“± åˆ›å»ºå¯åŠ¨å›¾..."
for density in "ldpi" "mdpi" "hdpi" "xhdpi"; do
    # åˆ›å»ºå ä½å¯åŠ¨å›¾
    touch "res/screen/android/screen-${density}-port.png"
    touch "res/screen/android/screen-${density}-land.png"
done

# æ£€æŸ¥å¹¶æ·»åŠ Androidå¹³å°
echo "ğŸ” æ£€æŸ¥Androidå¹³å°..."
if [ ! -d "platforms/android" ]; then
    echo "ğŸ“± æ·»åŠ Androidå¹³å°..."
    cordova platform add android
else
    echo "âœ… Androidå¹³å°å·²å­˜åœ¨"
fi

# å®‰è£…å¿…è¦çš„æ’ä»¶
echo "ğŸ”Œ å®‰è£…å¿…è¦çš„æ’ä»¶..."
cordova plugin add cordova-plugin-whitelist cordova-plugin-inappbrowser cordova-plugin-splashscreen cordova-plugin-network-information

# æ›´æ–°é…ç½®
echo "âš™ï¸ æ›´æ–°é…ç½®..."
# ç¡®ä¿config.xmlä¸­çš„é…ç½®æ­£ç¡®
sed -i 's/<content src=".*" \/>/<content src="index.html" \/>/' config.xml

# æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶
echo "ğŸ§¹ æ¸…ç†æ—§çš„æ„å»ºæ–‡ä»¶..."
rm -rf platforms/android/app/build

# æ„å»ºAPK
echo "ğŸ—ï¸ å¼€å§‹æ„å»ºAPK..."
echo "âš ï¸  æ³¨æ„ï¼šè¿™å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."

# ä½¿ç”¨--debugæ¨¡å¼æ„å»ºï¼Œé¿å…ç­¾åé—®é¢˜
cordova build android --debug

# æ£€æŸ¥æ„å»ºç»“æœ
if [ -f "platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
    echo "âœ… APKæ„å»ºæˆåŠŸï¼"
    echo "ğŸ“ APKæ–‡ä»¶ä½ç½®: platforms/android/app/build/outputs/apk/debug/app-debug.apk"
    
    # å¤åˆ¶åˆ°æ›´ç®€å•çš„ä½ç½®
    cp "platforms/android/app/build/outputs/apk/debug/app-debug.apk" "finance-app-debug.apk"
    echo "ğŸ“‹ å·²å¤åˆ¶åˆ°å½“å‰ç›®å½•: finance-app-debug.apk"
    
    echo ""
    echo "ğŸ‰ æ„å»ºå®Œæˆï¼"
    echo "ğŸ“± æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®‰è£…APKï¼š"
    echo "   1. å°†finance-app-debug.apkæ–‡ä»¶å¤åˆ¶åˆ°æ‚¨çš„Androidè®¾å¤‡"
    echo "   2. åœ¨è®¾å¤‡ä¸Šå¯ç”¨'æœªçŸ¥æ¥æºåº”ç”¨'æƒé™"
    echo "   3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…"
    echo ""
    echo "ğŸ”§ æç¤ºï¼šå¦‚æœéœ€è¦å‘å¸ƒç‰ˆæœ¬ï¼Œè¯·ä½¿ç”¨ --release å‚æ•°å¹¶è¿›è¡Œç­¾å"
    echo "   ä¾‹å¦‚ï¼šcordova build android --release"
else
    echo "âŒ APKæ„å»ºå¤±è´¥ï¼"
    echo "ğŸ“‹ é”™è¯¯ä¿¡æ¯ï¼š"
    tail -n 50 "platforms/android/cordova/build.log" 2>/dev/null || echo "æ— æ³•è¯»å–æ„å»ºæ—¥å¿—"
    exit 1
fi

echo ""
echo "ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®ï¼š"
echo "   1. è‡ªå®šä¹‰åº”ç”¨å›¾æ ‡å’Œå¯åŠ¨å›¾ï¼ˆæ›¿æ¢res/ç›®å½•ä¸‹çš„æ–‡ä»¶ï¼‰"
echo "   2. ä¿®æ”¹config.xmlä¸­çš„åº”ç”¨ä¿¡æ¯"
echo "   3. æ›´æ–°www/index.htmlä¸­çš„APP_URLä¸ºæ‚¨çš„å®é™…ç½‘ç«™åœ°å€"
echo "   4. è€ƒè™‘æ·»åŠ åº”ç”¨ç­¾åä»¥ç”Ÿæˆå‘å¸ƒç‰ˆæœ¬"